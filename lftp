---
- name: Download all files recursively from a remote SFTP server and maintain structure
  hosts: localhost
  gather_facts: no
  vars:
    sftp_host: "sftp.example.com"
    sftp_user: "your_username"
    sftp_password: "your_password"
    remote_dir: "/remote/path/"
    local_dir: "/local/path/"
  tasks:
    - name: Ensure local directory exists
      ansible.builtin.file:
        path: "{{ local_dir }}"
        state: directory
        mode: '0755'

    - name: Download files recursively
      ansible.builtin.shell: |
        sshpass -p '{{ sftp_password }}' lftp -c "
        open sftp://{{ sftp_user }}:{{ sftp_password }}@{{ sftp_host }}
        set xfer:use-temp-file yes
        set xfer:temp-file-name *.temp
        lcd {{ local_dir }}
        mirror --parallel=5 --use-pget-n=5 --continue --Remove-source-files {{ remote_dir }} .
        bye"
      args:
        chdir: "{{ local_dir }}"
